{"version":3,"file":"feature-validator.js","names":["FeatureValidator","validateFeature","feature","record","formValues","Record","validateRecord","RepeatableItemValue","validateRepeatableItem","errors","isStatusFieldEnabled","status","push","RequiredFieldValidationError","form","statusField","statusForValue","CustomValidationError","isGeometryRequired","hasCoordinate","GeometryRequiredValidationError","cache","validateFieldsInElements","elements","repeatableItem","element","visibilityCache","isSectionElement","visible","Condition","shouldElementBeVisible","required","shouldElementBeRequired","disabled","isDisabled","validatable","fieldValue","get","key","error","validateRequiredField","isTextElement","isNumeric","textValue","validateNumericField","hasPattern","validatePatternOfElement","isDateElement","validateDateField","isTimeElement","validateTimeField","isLengthValidationSupported","validateLengthForElement","isRepeatableElement","repeatableValue","items","item","itemValues","copy","merge","value","isEmpty","regex","RegExp","pattern","test","PatternValidationError","hasMinLengthError","hasMaxLengthError","hasMinLength","length","minLength","hasMaxLength","maxLength","LengthValidationError","NumericFormatValidationError","decimalSeparator","isIntegerFormat","indexOf","numberValue","hasMin","min","hasMax","max","NumericRangeValidationError","isValid","DateFormatValidationError","TimeFormatValidationError","formatErrors","messages","message","join"],"sources":["../../src/validation/feature-validator.js"],"sourcesContent":["import RepeatableItemValue from '../values/repeatable-item-value';\nimport Record from '../record';\nimport Condition from '../elements/condition';\nimport CustomValidationError from './custom-validation-error';\nimport RequiredFieldValidationError from './required-field-validation-error';\nimport GeometryRequiredValidationError from './geometry-required-validation-error';\nimport PatternValidationError from './pattern-validation-error';\nimport LengthValidationError from './length-validation-error';\nimport NumericFormatValidationError from './numeric-format-validation-error';\nimport NumericRangeValidationError from './numeric-range-validation-error';\nimport DateFormatValidationError from './date-format-validation-error';\nimport TimeFormatValidationError from './time-format-validation-error';\n\nexport default class FeatureValidator {\n  static validateFeature(feature, record, formValues) {\n    if (feature instanceof Record) {\n      return FeatureValidator.validateRecord(record, formValues);\n    } else if (feature instanceof RepeatableItemValue) {\n      return FeatureValidator.validateRepeatableItem(feature, record, formValues);\n    }\n\n    return [];\n  }\n\n  static validateRecord(record, formValues) {\n    if (record == null) {\n      return [];\n    }\n\n    const errors = [];\n\n    if (record.isStatusFieldEnabled) {\n      if (record.status == null) {\n        errors.push(new RequiredFieldValidationError(record.form.statusField));\n      } else if (record.form.statusField.statusForValue(record.status) == null) {\n        errors.push(new CustomValidationError(`${record.status} is not a valid status.`));\n      }\n    }\n\n    if (record.form.isGeometryRequired) {\n      if (!record.hasCoordinate) {\n        errors.push(new GeometryRequiredValidationError());\n      }\n    }\n\n    const cache = {};\n\n    this.validateFieldsInElements(record.form.elements, record, formValues, errors, cache);\n\n    return errors;\n  }\n\n  static validateRepeatableItem(repeatableItem, record, formValues) {\n    if (repeatableItem == null) {\n      return [];\n    }\n\n    const errors = [];\n\n    if (repeatableItem.element.isGeometryRequired) {\n      if (!repeatableItem.hasCoordinate) {\n        errors.push(new GeometryRequiredValidationError());\n      }\n    }\n\n    const cache = {};\n\n    FeatureValidator.validateFieldsInElements(repeatableItem.element.elements, record, formValues, errors, cache);\n\n    return errors;\n  }\n\n  static validateFieldsInElements(elements, record, formValues, errors, visibilityCache) {\n    const cache = visibilityCache || {};\n\n    for (const element of elements) {\n      if (element.isSectionElement) {\n        const visible = Condition.shouldElementBeVisible(element, record, formValues, cache);\n\n        if (visible) {\n          FeatureValidator.validateFieldsInElements(element.elements, record, formValues, errors, cache);\n        }\n      } else {\n        const required = Condition.shouldElementBeRequired(element, record, formValues);\n        const visible = Condition.shouldElementBeVisible(element, record, formValues, cache);\n\n        const disabled = element.isDisabled;\n\n        const validatable = (visible && !disabled);\n\n        if (validatable) {\n          if (required) {\n            const fieldValue = formValues.get(element.key);\n\n            const error = FeatureValidator.validateRequiredField(element, fieldValue);\n\n            if (error) {\n              errors.push(error);\n            }\n          }\n\n          if (element.isTextElement) {\n            if (element.isNumeric) {\n              const textValue = formValues.get(element.key);\n\n              const error = FeatureValidator.validateNumericField(element, textValue);\n\n              if (error) {\n                errors.push(error);\n              }\n            } else if (element.hasPattern) {\n              const textValue = formValues.get(element.key);\n\n              const error = FeatureValidator.validatePatternOfElement(element, textValue);\n\n              if (error) {\n                errors.push(error);\n              }\n            }\n          }\n\n          if (element.isDateElement) {\n            const error = FeatureValidator.validateDateField(element, formValues.get(element.key));\n\n            if (error) {\n              errors.push(error);\n            }\n          }\n\n          if (element.isTimeElement) {\n            const error = FeatureValidator.validateTimeField(element, formValues.get(element.key));\n\n            if (error) {\n              errors.push(error);\n            }\n          }\n\n          if (element.isLengthValidationSupported) {\n            const fieldValue = formValues.get(element.key);\n            const error = FeatureValidator.validateLengthForElement(element, fieldValue);\n\n            if (error) {\n              errors.push(error);\n            }\n          }\n        }\n\n        if (element.isRepeatableElement) {\n          const repeatableValue = formValues.get(element.key);\n\n          if (repeatableValue) {\n            for (const item of repeatableValue.items) {\n              const itemValues = item.formValues.copy();\n\n              itemValues.merge(formValues);\n\n              FeatureValidator.validateFieldsInElements(item.element.elements, record, itemValues, errors, null);\n            }\n          }\n        }\n      }\n    }\n  }\n\n  static validateRequiredField(element, value) {\n    if (value == null || value.isEmpty) {\n      return new RequiredFieldValidationError(element);\n    }\n\n    return null;\n  }\n\n  static validatePatternOfElement(element, value) {\n    if (value == null || value.isEmpty) {\n      return null;\n    }\n\n    const regex = new RegExp('^(?:' + element.pattern + ')$');\n\n    if (regex) {\n      if (!regex.test(value.textValue)) {\n        return new PatternValidationError(element);\n      }\n    }\n\n    return null;\n  }\n\n  static validateLengthForElement(element, value) {\n    if (value == null || value.isEmpty) {\n      return null;\n    }\n\n    let hasMinLengthError = false;\n    let hasMaxLengthError = false;\n\n    if (element.hasMinLength) {\n      hasMinLengthError = (value.length < element.minLength);\n    }\n\n    if (element.hasMaxLength) {\n      hasMaxLengthError = (value.length > element.maxLength);\n    }\n\n    if (hasMinLengthError || hasMaxLengthError) {\n      return new LengthValidationError(element);\n    }\n\n    return null;\n  }\n\n  static validateNumericField(element, value) {\n    if (value == null || value.isEmpty) {\n      return null;\n    }\n\n    if (!value.isNumeric) {\n      return new NumericFormatValidationError(element);\n    }\n\n    // since the number is now normalized to en_US, check for the . separator\n    const decimalSeparator = '.';\n\n    if (element.isIntegerFormat) {\n      if (value.textValue.indexOf(decimalSeparator) > -1) {\n        return new NumericFormatValidationError(element);\n      }\n    }\n\n    const numberValue = +value.textValue;\n\n    if ((element.hasMin && numberValue < element.min) || (element.hasMax && numberValue > element.max)) {\n      return new NumericRangeValidationError(element);\n    }\n\n    return null;\n  }\n\n  static validateDateField(element, value) {\n    if (value == null || value.isEmpty) {\n      return null;\n    }\n\n    if (!value.isValid) {\n      return new DateFormatValidationError(element);\n    }\n\n    return null;\n  }\n\n  static validateTimeField(element, value) {\n    if (value == null || value.isEmpty) {\n      return null;\n    }\n\n    if (!value.isValid) {\n      return new TimeFormatValidationError(element);\n    }\n\n    return null;\n  }\n\n  static formatErrors(errors) {\n    const messages = [];\n\n    for (const error of errors) {\n      messages.push(error.message);\n    }\n\n    return messages.join('\\n\\n');\n  }\n}\n"],"mappings":"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"}