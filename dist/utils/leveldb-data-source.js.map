{"version":3,"file":"leveldb-data-source.js","names":["CACHE_VERSION","LevelDBDataSource","db","cacheVersion","callbacks","initialize","callback","formVersions","choiceListVersions","classificationSetVersions","objects","checkVersion","Object","keys","id","push","type","version","getVersions","err","versions","async","each","object","cb","key","del","checkAlreadyFetching","length","invokeCallbacks","handler","get","value","notFound","JSON","parse","put","stringify","join","getChoiceList","json","ChoiceList","getClassificationSet","ClassificationSet","getForm","Form","getChoiceListComplete","updateObject","getClassificationSetComplete","getFormComplete","updateVersion","deleteAll","createKeyStream","on"],"sources":["../../src/utils/leveldb-data-source.js"],"sourcesContent":["import ChoiceList from '../choice-list';\nimport ClassificationSet from '../classification-set';\nimport Form from '../form';\nimport async from 'async';\n\nconst CACHE_VERSION = 1;\n\nexport default class LevelDBDataSource {\n  constructor(db, cacheVersion) {\n    this.db = db;\n    this.callbacks = [];\n    this.cacheVersion = cacheVersion || CACHE_VERSION;\n  }\n\n  initialize({formVersions, choiceListVersions, classificationSetVersions}, callback) {\n    const objects = [];\n\n    this.checkVersion(() => {\n      for (const id of Object.keys(formVersions)) {\n        objects.push({type: 'form', id, version: formVersions[id]});\n      }\n\n      for (const id of Object.keys(choiceListVersions)) {\n        objects.push({type: 'choice-list', id, version: choiceListVersions[id]});\n      }\n\n      for (const id of Object.keys(classificationSetVersions)) {\n        objects.push({type: 'classification-set', id, version: classificationSetVersions[id]});\n      }\n\n      this.getVersions((err, versions) => {\n        if (err) {\n          return callback(err);\n        }\n\n        return async.each(objects, (object, cb) => {\n          const key = this.key(object.type, object.id);\n          const version = object.version;\n\n          // delete the object from the cache if the versions don't match\n          if (versions[key] == null || versions[key] !== version) {\n            return this.del(key, cb);\n          }\n\n          return cb(err);\n        }, callback);\n      });\n    });\n  }\n\n  checkAlreadyFetching(id, callback) {\n    if (!this.callbacks[id]) {\n      this.callbacks[id] = [];\n    }\n\n    this.callbacks[id].push(callback);\n\n    return this.callbacks[id].length > 1;\n  }\n\n  invokeCallbacks(id, err, object) {\n    for (const handler of this.callbacks[id]) {\n      handler(err, object);\n    }\n\n    delete this.callbacks[id];\n  }\n\n  get(key, callback) {\n    return this.db.get(key, (err, value) => {\n      if (err && err.notFound) {\n        return callback(null, null);\n      }\n\n      return callback(err, value && JSON.parse(value));\n    });\n  }\n\n  del(key, callback) {\n    return this.db.del(key, callback);\n  }\n\n  put(key, value, callback) {\n    return this.db.put(key, JSON.stringify(value), callback);\n  }\n\n  key(type, id) {\n    return [ type, id ].join(':');\n  }\n\n  getChoiceList(id, callback) {\n    if (this.checkAlreadyFetching(id, callback)) {\n      return;\n    }\n\n    this.get(this.key('choice-list', id), (err, json) => {\n      this.invokeCallbacks(id, err, json ? new ChoiceList(json) : null);\n    });\n  }\n\n  getClassificationSet(id, callback) {\n    if (this.checkAlreadyFetching(id, callback)) {\n      return;\n    }\n\n    this.get(this.key('classification-set', id), (err, json) => {\n      this.invokeCallbacks(id, err, json ? new ClassificationSet(json) : null);\n    });\n  }\n\n  getForm(id, callback) {\n    if (this.checkAlreadyFetching(id, callback)) {\n      return;\n    }\n\n    this.get(this.key('form', id), (err, json) => {\n      this.invokeCallbacks(id, err, json ? new Form(json) : null);\n    });\n  }\n\n  getChoiceListComplete(id, object, callback) {\n    this.updateObject(this.key('choice-list', id), object, callback);\n  }\n\n  getClassificationSetComplete(id, object, callback) {\n    this.updateObject(this.key('classification-set', id), object, callback);\n  }\n\n  getFormComplete(id, object, callback) {\n    this.updateObject(this.key('form', id), object, callback);\n  }\n\n  updateObject(key, object, callback) {\n    this.put(key, object, (err) => {\n      if (err) {\n        return callback(err);\n      }\n\n      return this.updateVersion(key, object.version, callback);\n    });\n  }\n\n  getVersions(callback) {\n    this.get('versions', (err, object) => {\n      if (err) {\n        return callback(err);\n      }\n\n      return callback(null, object || {});\n    });\n  }\n\n  updateVersion(key, version, callback) {\n    this.getVersions((err, versions) => {\n      if (err) {\n        return callback(err);\n      }\n\n      versions[key] = version;\n\n      this.put('versions', versions, callback);\n\n      return null;\n    });\n  }\n\n  checkVersion(callback) {\n    this.get('version', (err, version) => {\n      if (err) {\n        return callback(err);\n      }\n\n      if (version !== this.cacheVersion) {\n        this.deleteAll((err) => {\n          if (err) {\n            return callback(err);\n          }\n\n          return this.put('version', this.cacheVersion, callback);\n        });\n\n        return null;\n      }\n\n      return callback();\n    });\n  }\n\n  deleteAll(callback) {\n    const keys = [];\n\n    this.db.createKeyStream()\n      .on('data', (key) => {\n        keys.push(key);\n      })\n      .on('close', () => {\n        async.each(keys, (key, cb) => {\n          this.del(key, cb);\n        }, callback);\n      });\n  }\n}\n"],"mappings":"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"}