{"version":3,"file":"leveldb-data-source.js","names":["CACHE_VERSION","LevelDBDataSource","db","cacheVersion","callbacks","initialize","callback","formVersions","choiceListVersions","classificationSetVersions","objects","checkVersion","Object","keys","id","push","type","version","getVersions","err","versions","async","each","object","cb","key","del","checkAlreadyFetching","length","invokeCallbacks","handler","get","value","notFound","JSON","parse","put","stringify","join","getChoiceList","json","ChoiceList","getClassificationSet","ClassificationSet","getForm","Form","getChoiceListComplete","updateObject","getClassificationSetComplete","getFormComplete","updateVersion","deleteAll","createKeyStream","on"],"sources":["../../src/utils/leveldb-data-source.js"],"sourcesContent":["import ChoiceList from '../choice-list';\nimport ClassificationSet from '../classification-set';\nimport Form from '../form';\nimport async from 'async';\n\nconst CACHE_VERSION = 1;\n\nexport default class LevelDBDataSource {\n  constructor(db, cacheVersion) {\n    this.db = db;\n    this.callbacks = [];\n    this.cacheVersion = cacheVersion || CACHE_VERSION;\n  }\n\n  initialize({formVersions, choiceListVersions, classificationSetVersions}, callback) {\n    const objects = [];\n\n    this.checkVersion(() => {\n      for (const id of Object.keys(formVersions)) {\n        objects.push({type: 'form', id, version: formVersions[id]});\n      }\n\n      for (const id of Object.keys(choiceListVersions)) {\n        objects.push({type: 'choice-list', id, version: choiceListVersions[id]});\n      }\n\n      for (const id of Object.keys(classificationSetVersions)) {\n        objects.push({type: 'classification-set', id, version: classificationSetVersions[id]});\n      }\n\n      this.getVersions((err, versions) => {\n        if (err) {\n          return callback(err);\n        }\n\n        return async.each(objects, (object, cb) => {\n          const key = this.key(object.type, object.id);\n          const version = object.version;\n\n          // delete the object from the cache if the versions don't match\n          if (versions[key] == null || versions[key] !== version) {\n            return this.del(key, cb);\n          }\n\n          return cb(err);\n        }, callback);\n      });\n    });\n  }\n\n  checkAlreadyFetching(id, callback) {\n    if (!this.callbacks[id]) {\n      this.callbacks[id] = [];\n    }\n\n    this.callbacks[id].push(callback);\n\n    return this.callbacks[id].length > 1;\n  }\n\n  invokeCallbacks(id, err, object) {\n    for (const handler of this.callbacks[id]) {\n      handler(err, object);\n    }\n\n    delete this.callbacks[id];\n  }\n\n  get(key, callback) {\n    return this.db.get(key, (err, value) => {\n      if (err && err.notFound) {\n        return callback(null, null);\n      }\n\n      return callback(err, value && JSON.parse(value));\n    });\n  }\n\n  del(key, callback) {\n    return this.db.del(key, callback);\n  }\n\n  put(key, value, callback) {\n    return this.db.put(key, JSON.stringify(value), callback);\n  }\n\n  key(type, id) {\n    return [ type, id ].join(':');\n  }\n\n  getChoiceList(id, callback) {\n    if (this.checkAlreadyFetching(id, callback)) {\n      return;\n    }\n\n    this.get(this.key('choice-list', id), (err, json) => {\n      this.invokeCallbacks(id, err, json ? new ChoiceList(json) : null);\n    });\n  }\n\n  getClassificationSet(id, callback) {\n    if (this.checkAlreadyFetching(id, callback)) {\n      return;\n    }\n\n    this.get(this.key('classification-set', id), (err, json) => {\n      this.invokeCallbacks(id, err, json ? new ClassificationSet(json) : null);\n    });\n  }\n\n  getForm(id, callback) {\n    if (this.checkAlreadyFetching(id, callback)) {\n      return;\n    }\n\n    this.get(this.key('form', id), (err, json) => {\n      this.invokeCallbacks(id, err, json ? new Form(json) : null);\n    });\n  }\n\n  getChoiceListComplete(id, object, callback) {\n    this.updateObject(this.key('choice-list', id), object, callback);\n  }\n\n  getClassificationSetComplete(id, object, callback) {\n    this.updateObject(this.key('classification-set', id), object, callback);\n  }\n\n  getFormComplete(id, object, callback) {\n    this.updateObject(this.key('form', id), object, callback);\n  }\n\n  updateObject(key, object, callback) {\n    this.put(key, object, (err) => {\n      if (err) {\n        return callback(err);\n      }\n\n      return this.updateVersion(key, object.version, callback);\n    });\n  }\n\n  getVersions(callback) {\n    this.get('versions', (err, object) => {\n      if (err) {\n        return callback(err);\n      }\n\n      return callback(null, object || {});\n    });\n  }\n\n  updateVersion(key, version, callback) {\n    this.getVersions((err, versions) => {\n      if (err) {\n        return callback(err);\n      }\n\n      versions[key] = version;\n\n      this.put('versions', versions, callback);\n\n      return null;\n    });\n  }\n\n  checkVersion(callback) {\n    this.get('version', (err, version) => {\n      if (err) {\n        return callback(err);\n      }\n\n      if (version !== this.cacheVersion) {\n        this.deleteAll((err) => {\n          if (err) {\n            return callback(err);\n          }\n\n          return this.put('version', this.cacheVersion, callback);\n        });\n\n        return null;\n      }\n\n      return callback();\n    });\n  }\n\n  deleteAll(callback) {\n    const keys = [];\n\n    this.db.createKeyStream()\n      .on('data', (key) => {\n        keys.push(key);\n      })\n      .on('close', () => {\n        async.each(keys, (key, cb) => {\n          this.del(key, cb);\n        }, callback);\n      });\n  }\n}\n"],"mappings":"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"}