{"version":3,"sources":["../../src/utils/leveldb-data-source.js"],"names":["CACHE_VERSION","LevelDBDataSource","db","cacheVersion","callbacks","initialize","callback","formVersions","choiceListVersions","classificationSetVersions","objects","checkVersion","Object","keys","id","push","type","version","getVersions","err","versions","async","each","object","cb","key","del","checkAlreadyFetching","length","invokeCallbacks","handler","get","value","notFound","JSON","parse","put","stringify","join","getChoiceList","json","ChoiceList","getClassificationSet","ClassificationSet","getForm","Form","getChoiceListComplete","updateObject","getClassificationSetComplete","getFormComplete","updateVersion","deleteAll","createKeyStream","on"],"mappings":"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","sourcesContent":["import ChoiceList from '../choice-list';\nimport ClassificationSet from '../classification-set';\nimport Form from '../form';\nimport async from 'async';\n\nconst CACHE_VERSION = 1;\n\nexport default class LevelDBDataSource {\n  constructor(db, cacheVersion) {\n    this.db = db;\n    this.callbacks = [];\n    this.cacheVersion = cacheVersion || CACHE_VERSION;\n  }\n\n  initialize({formVersions, choiceListVersions, classificationSetVersions}, callback) {\n    const objects = [];\n\n    this.checkVersion(() => {\n      for (const id of Object.keys(formVersions)) {\n        objects.push({type: 'form', id, version: formVersions[id]});\n      }\n\n      for (const id of Object.keys(choiceListVersions)) {\n        objects.push({type: 'choice-list', id, version: choiceListVersions[id]});\n      }\n\n      for (const id of Object.keys(classificationSetVersions)) {\n        objects.push({type: 'classification-set', id, version: classificationSetVersions[id]});\n      }\n\n      this.getVersions((err, versions) => {\n        if (err) {\n          return callback(err);\n        }\n\n        return async.each(objects, (object, cb) => {\n          const key = this.key(object.type, object.id);\n          const version = object.version;\n\n          // delete the object from the cache if the versions don't match\n          if (versions[key] == null || versions[key] !== version) {\n            return this.del(key, cb);\n          }\n\n          return cb(err);\n        }, callback);\n      });\n    });\n  }\n\n  checkAlreadyFetching(id, callback) {\n    if (!this.callbacks[id]) {\n      this.callbacks[id] = [];\n    }\n\n    this.callbacks[id].push(callback);\n\n    return this.callbacks[id].length > 1;\n  }\n\n  invokeCallbacks(id, err, object) {\n    for (const handler of this.callbacks[id]) {\n      handler(err, object);\n    }\n\n    delete this.callbacks[id];\n  }\n\n  get(key, callback) {\n    return this.db.get(key, (err, value) => {\n      if (err && err.notFound) {\n        return callback(null, null);\n      }\n\n      return callback(err, value && JSON.parse(value));\n    });\n  }\n\n  del(key, callback) {\n    return this.db.del(key, callback);\n  }\n\n  put(key, value, callback) {\n    return this.db.put(key, JSON.stringify(value), callback);\n  }\n\n  key(type, id) {\n    return [ type, id ].join(':');\n  }\n\n  getChoiceList(id, callback) {\n    if (this.checkAlreadyFetching(id, callback)) {\n      return;\n    }\n\n    this.get(this.key('choice-list', id), (err, json) => {\n      this.invokeCallbacks(id, err, json ? new ChoiceList(json) : null);\n    });\n  }\n\n  getClassificationSet(id, callback) {\n    if (this.checkAlreadyFetching(id, callback)) {\n      return;\n    }\n\n    this.get(this.key('classification-set', id), (err, json) => {\n      this.invokeCallbacks(id, err, json ? new ClassificationSet(json) : null);\n    });\n  }\n\n  getForm(id, callback) {\n    if (this.checkAlreadyFetching(id, callback)) {\n      return;\n    }\n\n    this.get(this.key('form', id), (err, json) => {\n      this.invokeCallbacks(id, err, json ? new Form(json) : null);\n    });\n  }\n\n  getChoiceListComplete(id, object, callback) {\n    this.updateObject(this.key('choice-list', id), object, callback);\n  }\n\n  getClassificationSetComplete(id, object, callback) {\n    this.updateObject(this.key('classification-set', id), object, callback);\n  }\n\n  getFormComplete(id, object, callback) {\n    this.updateObject(this.key('form', id), object, callback);\n  }\n\n  updateObject(key, object, callback) {\n    this.put(key, object, (err) => {\n      if (err) {\n        return callback(err);\n      }\n\n      return this.updateVersion(key, object.version, callback);\n    });\n  }\n\n  getVersions(callback) {\n    this.get('versions', (err, object) => {\n      if (err) {\n        return callback(err);\n      }\n\n      return callback(null, object || {});\n    });\n  }\n\n  updateVersion(key, version, callback) {\n    this.getVersions((err, versions) => {\n      if (err) {\n        return callback(err);\n      }\n\n      versions[key] = version;\n\n      this.put('versions', versions, callback);\n\n      return null;\n    });\n  }\n\n  checkVersion(callback) {\n    this.get('version', (err, version) => {\n      if (err) {\n        return callback(err);\n      }\n\n      if (version !== this.cacheVersion) {\n        this.deleteAll((err) => {\n          if (err) {\n            return callback(err);\n          }\n\n          return this.put('version', this.cacheVersion, callback);\n        });\n\n        return null;\n      }\n\n      return callback();\n    });\n  }\n\n  deleteAll(callback) {\n    const keys = [];\n\n    this.db.createKeyStream()\n      .on('data', (key) => {\n        keys.push(key);\n      })\n      .on('close', () => {\n        async.each(keys, (key, cb) => {\n          this.del(key, cb);\n        }, callback);\n      });\n  }\n}\n"],"file":"leveldb-data-source.js"}