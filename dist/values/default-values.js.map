{"version":3,"file":"default-values.js","names":["NOW","DefaultValues","applyDefaultValue","elementDefaultValue","element","formValues","defaultValue","value","get","key","hasValue","isEmpty","length","isDateElement","DateUtils","formatDate","Date","isTimeElement","formatTime","fieldValue","createValueFromString","set","applyPreviousDefaults","dataSource","defaultValues","record","callback","elements","elementsWithPreviousDefaultsEnabledWithinElements","form","async","eachSeries","next","previousDefaultAsJSON","completion","createValue","currentValue","isCurrentlyEmpty","isRecordLinkElement","applyDefaultValuesForRecordLinkValue","recordLinkValue","recordLinkElement","itemValue","items","maybeLoadRecord","load","otherRecord","recordDefaults","recordDefault","otherValue","sourceKey","newElement","elementsByKey","destinationKey","newValue","createValueFromOtherValue","applyDefaultValueForElement","applyDefaultValuesForElements","hasStatusDefault","statusField","TextUtils","isPresent","isEnabled","status","applyDefaultValuesForElementsRecursive","isSectionElement","results","isDefaultPreviousValueEnabled","push","Array","prototype","apply"],"sources":["../../src/values/default-values.js"],"sourcesContent":["import DateUtils from '../utils/date-utils';\nimport TextUtils from '../utils/text-utils';\nimport async from 'async';\n\nconst NOW = 'now';\n\nexport default class DefaultValues {\n  static applyDefaultValue(elementDefaultValue, element, formValues) {\n    let defaultValue = elementDefaultValue;\n\n    const value = formValues.get(element.key);\n\n    const hasValue = value && !value.isEmpty;\n\n    if (hasValue || defaultValue == null || defaultValue.length === 0) {\n      return;\n    }\n\n    if (element.isDateElement && defaultValue === NOW) {\n      defaultValue = DateUtils.formatDate(new Date());\n    } else if (element.isTimeElement && defaultValue === NOW) {\n      defaultValue = DateUtils.formatTime(new Date());\n    }\n\n    const fieldValue = formValues.createValueFromString(element, defaultValue);\n\n    if (fieldValue) {\n      formValues.set(element.key, fieldValue);\n    }\n  }\n\n  static applyPreviousDefaults(dataSource, defaultValues, formValues, record, callback) {\n    if (defaultValues == null) {\n      return;\n    }\n\n    const elements = DefaultValues.elementsWithPreviousDefaultsEnabledWithinElements(formValues.elements, record.form);\n\n    async.eachSeries(elements, (element, next) => {\n      const previousDefaultAsJSON = defaultValues[element.key];\n\n      // the default completion is just to continue the loop\n      let completion = next;\n\n      if (previousDefaultAsJSON) {\n        const fieldValue = formValues.createValue(element, previousDefaultAsJSON);\n        const currentValue = record.get(element.key, formValues);\n\n        const isCurrentlyEmpty = (currentValue == null || currentValue.isEmpty);\n\n        if (fieldValue && isCurrentlyEmpty) {\n          record.set(element.key, fieldValue, formValues);\n\n          if (element.isRecordLinkElement) {\n            completion = () => {\n              DefaultValues.applyDefaultValuesForRecordLinkValue(dataSource, fieldValue, formValues, record, next);\n            };\n          }\n        }\n      }\n\n      completion();\n    }, callback);\n  }\n\n  static applyDefaultValuesForRecordLinkValue(dataSource, recordLinkValue, formValues, record, callback) {\n    const recordLinkElement = recordLinkValue.element;\n\n    const itemValue = recordLinkValue.items[recordLinkValue.length - 1];\n\n    const maybeLoadRecord = (itemValue, callback) => {\n      if (itemValue.record) {\n        callback();\n      } else {\n        itemValue.load(dataSource, callback);\n      }\n    };\n\n    maybeLoadRecord(itemValue, () => {\n      const otherRecord = itemValue.record;\n\n      if (otherRecord) {\n        for (const recordDefault of recordLinkElement.recordDefaults) {\n          const otherValue = otherRecord.get(recordDefault.sourceKey, otherRecord.formValues);\n\n          // TODO(zhm) verify container here\n          // FCMElement *newElement = [record.form elementByKey:recordDefault.destinationKey withinContainer:nil];\n          const newElement = record.form.elementsByKey[recordDefault.destinationKey];\n\n          if (newElement) {\n            const newValue = formValues.createValueFromOtherValue(newElement, otherValue);\n\n            if (newValue) {\n              record.set(recordDefault.destinationKey, newValue, formValues);\n            }\n          }\n        }\n      }\n\n      callback();\n    });\n  }\n\n  static applyDefaultValueForElement(element, formValues) {\n    const defaultValue = element.defaultValue;\n\n    if (defaultValue == null) {\n      return;\n    }\n\n    DefaultValues.applyDefaultValue(defaultValue, element, formValues);\n  }\n\n  static applyDefaultValuesForElements(elements, formValues, record) {\n    const hasStatusDefault = (record.form.statusField &&\n                              TextUtils.isPresent(record.form.statusField.defaultValue) &&\n                              record.form.statusField.isEnabled);\n\n    if (hasStatusDefault && TextUtils.isEmpty(record.status)) {\n      record.status = record.form.statusField.defaultValue;\n    }\n\n    DefaultValues.applyDefaultValuesForElementsRecursive(elements, formValues);\n  }\n\n  static applyDefaultValuesForElementsRecursive(elements, formValues) {\n    for (const element of elements) {\n      if (element.isSectionElement) {\n        DefaultValues.applyDefaultValuesForElementsRecursive(element.elements, formValues);\n      } else {\n        DefaultValues.applyDefaultValueForElement(element, formValues);\n      }\n    }\n  }\n\n  static elementsWithPreviousDefaultsEnabledWithinElements(elements, form) {\n    const results = [];\n\n    if (form && form.statusField.isEnabled && form.statusField.isDefaultPreviousValueEnabled) {\n      results.push(form.statusField);\n    }\n\n    for (const element of elements) {\n      if (element.isSectionElement) {\n        // when recursing don't pass in the form, so the status field is only added once\n        Array.prototype.push.apply(results, DefaultValues.elementsWithPreviousDefaultsEnabledWithinElements(element.elements, null));\n      } else if (element.isDefaultPreviousValueEnabled) {\n        results.push(element);\n      }\n    }\n\n    return results;\n  }\n}\n"],"mappings":"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"}