{"version":3,"file":"default-values.js","names":["NOW","DefaultValues","applyDefaultValue","elementDefaultValue","element","formValues","defaultValue","value","get","key","hasValue","isEmpty","length","isDateElement","DateUtils","formatDate","Date","isTimeElement","formatTime","fieldValue","createValueFromString","set","applyPreviousDefaults","dataSource","defaultValues","record","callback","elements","elementsWithPreviousDefaultsEnabledWithinElements","form","async","eachSeries","next","previousDefaultAsJSON","completion","createValue","currentValue","isCurrentlyEmpty","isRecordLinkElement","applyDefaultValuesForRecordLinkValue","recordLinkValue","recordLinkElement","itemValue","items","maybeLoadRecord","load","otherRecord","recordDefaults","recordDefault","otherValue","sourceKey","newElement","elementsByKey","destinationKey","newValue","createValueFromOtherValue","applyDefaultValueForElement","applyDefaultValuesForElements","hasStatusDefault","statusField","TextUtils","isPresent","isEnabled","status","applyDefaultValuesForElementsRecursive","isSectionElement","results","isDefaultPreviousValueEnabled","push","Array","prototype","apply"],"sources":["../../src/values/default-values.js"],"sourcesContent":["import DateUtils from '../utils/date-utils';\nimport TextUtils from '../utils/text-utils';\nimport async from 'async';\n\nconst NOW = 'now';\n\nexport default class DefaultValues {\n  static applyDefaultValue(elementDefaultValue, element, formValues) {\n    let defaultValue = elementDefaultValue;\n\n    const value = formValues.get(element.key);\n\n    const hasValue = value && !value.isEmpty;\n\n    if (hasValue || defaultValue == null || defaultValue.length === 0) {\n      return;\n    }\n\n    if (element.isDateElement && defaultValue === NOW) {\n      defaultValue = DateUtils.formatDate(new Date());\n    } else if (element.isTimeElement && defaultValue === NOW) {\n      defaultValue = DateUtils.formatTime(new Date());\n    }\n\n    const fieldValue = formValues.createValueFromString(element, defaultValue);\n\n    if (fieldValue) {\n      formValues.set(element.key, fieldValue);\n    }\n  }\n\n  static applyPreviousDefaults(dataSource, defaultValues, formValues, record, callback) {\n    if (defaultValues == null) {\n      return;\n    }\n\n    const elements = DefaultValues.elementsWithPreviousDefaultsEnabledWithinElements(formValues.elements, record.form);\n\n    async.eachSeries(elements, (element, next) => {\n      const previousDefaultAsJSON = defaultValues[element.key];\n\n      // the default completion is just to continue the loop\n      let completion = next;\n\n      if (previousDefaultAsJSON) {\n        const fieldValue = formValues.createValue(element, previousDefaultAsJSON);\n        const currentValue = record.get(element.key, formValues);\n\n        const isCurrentlyEmpty = (currentValue == null || currentValue.isEmpty);\n\n        if (fieldValue && isCurrentlyEmpty) {\n          record.set(element.key, fieldValue, formValues);\n\n          if (element.isRecordLinkElement) {\n            completion = () => {\n              DefaultValues.applyDefaultValuesForRecordLinkValue(dataSource, fieldValue, formValues, record, next);\n            };\n          }\n        }\n      }\n\n      completion();\n    }, callback);\n  }\n\n  static applyDefaultValuesForRecordLinkValue(dataSource, recordLinkValue, formValues, record, callback) {\n    const recordLinkElement = recordLinkValue.element;\n\n    const itemValue = recordLinkValue.items[recordLinkValue.length - 1];\n\n    const maybeLoadRecord = (itemValue, callback) => {\n      if (itemValue.record) {\n        callback();\n      } else {\n        itemValue.load(dataSource, callback);\n      }\n    };\n\n    maybeLoadRecord(itemValue, () => {\n      const otherRecord = itemValue.record;\n\n      if (otherRecord) {\n        for (const recordDefault of recordLinkElement.recordDefaults) {\n          const otherValue = otherRecord.get(recordDefault.sourceKey, otherRecord.formValues);\n\n          // TODO(zhm) verify container here\n          // FCMElement *newElement = [record.form elementByKey:recordDefault.destinationKey withinContainer:nil];\n          const newElement = record.form.elementsByKey[recordDefault.destinationKey];\n\n          if (newElement) {\n            const newValue = formValues.createValueFromOtherValue(newElement, otherValue);\n\n            if (newValue) {\n              record.set(recordDefault.destinationKey, newValue, formValues);\n            }\n          }\n        }\n      }\n\n      callback();\n    });\n  }\n\n  static applyDefaultValueForElement(element, formValues) {\n    const defaultValue = element.defaultValue;\n\n    if (defaultValue == null) {\n      return;\n    }\n\n    DefaultValues.applyDefaultValue(defaultValue, element, formValues);\n  }\n\n  static applyDefaultValuesForElements(elements, formValues, record) {\n    const hasStatusDefault = (record.form.statusField &&\n                              TextUtils.isPresent(record.form.statusField.defaultValue) &&\n                              record.form.statusField.isEnabled);\n\n    if (hasStatusDefault && TextUtils.isEmpty(record.status)) {\n      record.status = record.form.statusField.defaultValue;\n    }\n\n    DefaultValues.applyDefaultValuesForElementsRecursive(elements, formValues);\n  }\n\n  static applyDefaultValuesForElementsRecursive(elements, formValues) {\n    for (const element of elements) {\n      if (element.isSectionElement) {\n        DefaultValues.applyDefaultValuesForElementsRecursive(element.elements, formValues);\n      } else {\n        DefaultValues.applyDefaultValueForElement(element, formValues);\n      }\n    }\n  }\n\n  static elementsWithPreviousDefaultsEnabledWithinElements(elements, form) {\n    const results = [];\n\n    if (form && form.statusField.isEnabled && form.statusField.isDefaultPreviousValueEnabled) {\n      results.push(form.statusField);\n    }\n\n    for (const element of elements) {\n      if (element.isSectionElement) {\n        // when recursing don't pass in the form, so the status field is only added once\n        Array.prototype.push.apply(results, DefaultValues.elementsWithPreviousDefaultsEnabledWithinElements(element.elements, null));\n      } else if (element.isDefaultPreviousValueEnabled) {\n        results.push(element);\n      }\n    }\n\n    return results;\n  }\n}\n"],"mappings":"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"}